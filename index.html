<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Маршруты в Калининграде</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=20981a8c-b8ac-4af3-a0ff-7d13b7dfd0ae" type="text/javascript"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            touch-action: manipulation;
            overscroll-behavior-y: none;
        }
        #map {
            height: 65vh;
            width: 100%;
        }
        .container {
            padding: 12px;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .button {
            padding: 10px 12px;
            background-color: #3399ff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            transition: background-color 0.2s;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
        }
        .button:hover {
            background-color: #267acc;
        }
        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .info {
            font-size: 13px;
            margin: 8px 0;
            color: #555;
            line-height: 1.4;
        }
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .route-info {
            background-color: #f0f8ff;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
        }
        .point-buttons {
            display: flex;
            gap: 8px;
        }
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        @media (min-width: 500px) {
            .controls {
                flex-direction: row;
            }
            .point-buttons {
                flex: 2;
            }
            .action-buttons {
                flex: 1;
            }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="container">
        <div class="controls">
            <div class="point-buttons">
                <button id="setStartBtn" class="button">Начало</button>
                <button id="setEndBtn" class="button">Конец</button>
            </div>
            <div class="action-buttons">
                <button id="buildRouteBtn" class="button" disabled>Построить</button>
            </div>
        </div>
        
        <div class="info" id="infoMessage">Выберите начальную и конечную точки</div>
        
        <div class="route-info" id="routeInfo" style="display: none;">
            <div><strong>Начало:</strong> <span id="startPointInfo">не указано</span></div>
            <div><strong>Конец:</strong> <span id="endPointInfo">не указано</span></div>
            <div><strong>Длина:</strong> <span id="routeLength">-</span></div>
            <div><strong>Время:</strong> <span id="routeTime">-</span></div>
        </div>
        
        <button id="sendToBotBtn" class="button" disabled style="margin-top: 8px;">Отправить в бот</button>
    </div>

    <script>
        // Проверяем, запущено ли в Telegram WebApp
        const isTelegramWebApp = () => {
            return window.Telegram && Telegram.WebApp;
        };

        // Оптимизация: отложенная загрузка карты
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initMap, 100); // Небольшая задержка для улучшения восприятия
        });

        function initMap() {
            // Границы Калининградской области
            const kaliningradBounds = [
                [54.56, 19.85], // Юго-запад
                [55.15, 21.10]  // Северо-восток
            ];
            
            // Центр Калининграда
            const kaliningradCenter = [54.7104, 20.4522];
            
            // Создаем карту с минимальными элементами управления
            const map = new ymaps.Map('map', {
                center: kaliningradCenter,
                zoom: 12,
                controls: ['zoomControl']
            }, {
                suppressMapOpenBlock: true // Убираем лишние элементы
            });
            
            // Жестко ограничиваем область
            map.setBounds(kaliningradBounds, {
                checkZoomRange: true,
                zoomMargin: 0
            });
            
            // Блокируем выход за границы
            map.options.set('restrictMapArea', kaliningradBounds);
            map.behaviors.disable('scrollZoom');
            
            // Оптимизация: ограничение частоты событий
            let lastClickTime = 0;
            const clickDebounceTime = 300;
            
            // Переменные для хранения состояния
            let startPoint = null;
            let endPoint = null;
            let route = null;
            let selectionMode = null;
            
            // Кэшируем DOM-элементы
            const elements = {
                infoMessage: document.getElementById('infoMessage'),
                routeInfo: document.getElementById('routeInfo'),
                startPointInfo: document.getElementById('startPointInfo'),
                endPointInfo: document.getElementById('endPointInfo'),
                routeLength: document.getElementById('routeLength'),
                routeTime: document.getElementById('routeTime'),
                buildRouteBtn: document.getElementById('buildRouteBtn'),
                sendToBotBtn: document.getElementById('sendToBotBtn'),
                setStartBtn: document.getElementById('setStartBtn'),
                setEndBtn: document.getElementById('setEndBtn')
            };
            
            // Улучшенная проверка координат
            const isInKaliningrad = (coords) => {
                const [lat, lng] = coords;
                return lat >= kaliningradBounds[0][0] && lat <= kaliningradBounds[1][0] &&
                       lng >= kaliningradBounds[0][1] && lng <= kaliningradBounds[1][1];
            };
            
            // Обработчики кнопок
            elements.setStartBtn.addEventListener('click', () => {
                selectionMode = 'start';
                elements.infoMessage.textContent = "Выберите начальную точку на карте";
            });
            
            elements.setEndBtn.addEventListener('click', () => {
                selectionMode = 'end';
                elements.infoMessage.textContent = "Выберите конечную точку на карте";
            });
            
            // Оптимизированный обработчик клика
            map.events.add('click', (e) => {
                const now = Date.now();
                if (now - lastClickTime < clickDebounceTime || !selectionMode) return;
                lastClickTime = now;
                
                const coords = e.get('coords');
                if (!isInKaliningrad(coords)) {
                    elements.infoMessage.textContent = "Выберите точку в пределах Калининградской области";
                    return;
                }
                
                // Удаляем предыдущую точку
                if (selectionMode === 'start' && startPoint) {
                    map.geoObjects.remove(startPoint);
                } else if (selectionMode === 'end' && endPoint) {
                    map.geoObjects.remove(endPoint);
                }
                
                // Создаем новую точку
                const placemark = new ymaps.Placemark(coords, {
                    balloonContent: selectionMode === 'start' ? "Начало маршрута" : "Конец маршрута"
                }, {
                    preset: selectionMode === 'start' ? 'islands#greenDotIcon' : 'islands#redDotIcon',
                    draggable: true,
                    iconColor: selectionMode === 'start' ? '#00aa00' : '#ff0000'
                });
                
                map.geoObjects.add(placemark);
                
                // Сохраняем точку
                if (selectionMode === 'start') {
                    startPoint = placemark;
                    elements.startPointInfo.textContent = formatCoords(coords);
                } else {
                    endPoint = placemark;
                    elements.endPointInfo.textContent = formatCoords(coords);
                }
                
                // Обработчик перемещения точки
                placemark.events.add('dragend', () => {
                    const newCoords = placemark.geometry.getCoordinates();
                    if (!isInKaliningrad(newCoords)) {
                        placemark.geometry.setCoordinates(correctCoords(newCoords));
                        return;
                    }
                    
                    if (selectionMode === 'start') {
                        elements.startPointInfo.textContent = formatCoords(newCoords);
                    } else {
                        elements.endPointInfo.textContent = formatCoords(newCoords);
                    }
                    
                    if (route) buildRoute();
                });
                
                selectionMode = null;
                updateUI();
            });
            
            // Построение маршрута с обработкой ошибок
            elements.buildRouteBtn.addEventListener('click', buildRoute);
            
            function buildRoute() {
                if (!startPoint || !endPoint) return;
                
                // Показываем загрузку
                elements.infoMessage.textContent = "Строим маршрут...";
                
                // Удаляем предыдущий маршрут
                if (route) {
                    map.geoObjects.remove(route);
                }
                
                const startCoords = startPoint.geometry.getCoordinates();
                const endCoords = endPoint.geometry.getCoordinates();
                
                // Оптимизация: используем только автомобильный маршрут
                ymaps.route([startCoords, endCoords], {
                    mapStateAutoApply: true,
                    boundedBy: kaliningradBounds,
                    avoidTrafficJams: true,
                    routingMode: 'auto'
                }).then(
                    (r) => {
                        route = r;
                        map.geoObjects.add(route);
                        
                        // Обновляем информацию
                        elements.routeLength.textContent = `${(route.getLength() / 1000).toFixed(1)} км`;
                        elements.routeTime.textContent = `${Math.round(route.getJamsTime() / 60)} мин`;
                        
                        updateUI();
                        elements.infoMessage.textContent = "Маршрут построен";
                    },
                    (error) => {
                        console.error("Route error:", error);
                        elements.infoMessage.textContent = "Не удалось построить маршрут. Попробуйте другие точки";
                    }
                );
            }
            
            // Отправка данных в бот
            elements.sendToBotBtn.addEventListener('click', () => {
                if (!startPoint || !endPoint) return;
                
                const routeData = {
                    start: startPoint.geometry.getCoordinates(),
                    end: endPoint.geometry.getCoordinates()
                };
                
                if (route) {
                    routeData.distance = (route.getLength() / 1000).toFixed(1);
                    routeData.duration = Math.round(route.getJamsTime() / 60);
                }
                
                if (isTelegramWebApp()) {
                    Telegram.WebApp.sendData(JSON.stringify(routeData));
                } else {
                    alert(`Данные маршрута:\n${JSON.stringify(routeData, null, 2)}`);
                }
            });
            
            // Вспомогательные функции
            function correctCoords(coords) {
                const [lat, lng] = coords;
                return [
                    Math.max(kaliningradBounds[0][0], Math.min(kaliningradBounds[1][0], lat)),
                    Math.max(kaliningradBounds[0][1], Math.min(kaliningradBounds[1][1], lng))
                ];
            }
            
            function formatCoords(coords) {
                return `${coords[0].toFixed(5)}, ${coords[1].toFixed(5)}`;
            }
            
            function updateUI() {
                if (startPoint && endPoint) {
                    elements.buildRouteBtn.disabled = false;
                    elements.routeInfo.style.display = 'block';
                    elements.sendToBotBtn.disabled = false;
                } else {
                    elements.buildRouteBtn.disabled = true;
                    elements.sendToBotBtn.disabled = true;
                }
            }
            
            // Адаптация под Telegram WebApp
            if (isTelegramWebApp()) {
                Telegram.WebApp.expand();
                document.body.style.backgroundColor = Telegram.WebApp.backgroundColor;
            }
        }
    </script>
</body>
</html>
