<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Выбор точек в Калининграде</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 70vh; }
        .panel { padding: 10px; background: #fff; text-align: center; }
        .button { 
            padding: 10px 15px; 
            margin: 5px; 
            background: #3399ff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
        }
        .status { margin: 10px 0; color: #555; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="panel">
        <button id="startBtn" class="button">Точка А</button>
        <button id="endBtn" class="button">Точка Б</button>
        <button id="sendBtn" class="button" disabled>Отправить</button>
        <div class="status" id="status">Выберите обе точки в Калининградской области</div>
    </div>

    <script>
        ymaps.ready(init);

        function init() {
            // Границы Калининградской области
            const kaliningradBounds = [
                [54.56, 19.85], // Юго-запад
                [55.15, 21.10]  // Северо-восток
            ];

            // Центр Калининграда
            const map = new ymaps.Map('map', {
                center: [54.7135, 20.5113],
                zoom: 12,
                restrictMapArea: kaliningradBounds
            });

            // Ограничиваем зону карты
            map.setBounds(kaliningradBounds, { checkZoomRange: true });
            map.behaviors.disable('scrollZoom');

            let points = {
                start: null,
                end: null
            };
            let currentMode = null;

            // Проверка координат в области
            function isInKaliningrad(coords) {
                const [lat, lon] = coords;
                return lat >= kaliningradBounds[0][0] && lat <= kaliningradBounds[1][0] &&
                       lon >= kaliningradBounds[0][1] && lon <= kaliningradBounds[1][1];
            }

            // Кнопки выбора точек
            document.getElementById('startBtn').addEventListener('click', () => {
                currentMode = 'start';
                updateStatus('Выберите точку А на карте');
            });

            document.getElementById('endBtn').addEventListener('click', () => {
                currentMode = 'end';
                updateStatus('Выберите точку Б на карте');
            });

            // Клик по карте
            map.events.add('click', (e) => {
                if (!currentMode) return;
                
                const coords = e.get('coords');
                
                if (!isInKaliningrad(coords)) {
                    updateStatus('Выберите точку в пределах Калининградской области');
                    return;
                }

                // Удаляем предыдущую точку
                if (points[currentMode]) {
                    map.geoObjects.remove(points[currentMode].marker);
                }

                // Создаем маркер
                const marker = new ymaps.Placemark(coords, {}, {
                    preset: currentMode === 'start' 
                        ? 'islands#blueIcon' 
                        : 'islands#redIcon',
                    draggable: true
                });

                // Обработка перемещения маркера
                marker.events.add('dragend', function(e) {
                    const newCoords = e.get('target').geometry.getCoordinates();
                    if (!isInKaliningrad(newCoords)) {
                        e.get('target').geometry.setCoordinates(points[currentMode].coords);
                        updateStatus('Точка должна быть в пределах области');
                    } else {
                        points[currentMode].coords = newCoords;
                    }
                });

                map.geoObjects.add(marker);
                
                // Сохраняем данные
                points[currentMode] = {
                    coords: coords,
                    marker: marker
                };

                currentMode = null;
                checkPoints();
            });

            // Отправка в бота
            document.getElementById('sendBtn').addEventListener('click', () => {
                if (!points.start || !points.end) return;
                
                const data = {
                    start: points.start.coords,
                    end: points.end.coords
                };

                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.sendData(JSON.stringify(data));
                    Telegram.WebApp.close();
                }
            });

            function checkPoints() {
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = !(points.start && points.end);
                
                if (points.start && points.end) {
                    updateStatus('Готово к отправке');
                } else {
                    updateStatus(points.start ? 'Выберите точку Б' : 'Выберите точку А');
                }
            }

            function updateStatus(text) {
                document.getElementById('status').textContent = text;
            }
        }
    </script>
</body>
</html>
