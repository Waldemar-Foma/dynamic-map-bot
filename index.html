<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Народное Такси</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p3p2xNq+Dr9DTV3ZpJX8iuf6kPZv7zWxgA5r6z3SYXI="
    crossorigin=""
  />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .info-box {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      font-size: 14px;
      max-height: 30%;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info-box" id="infoBox">
    <b>Информация о поездке:</b>
    <div id="info"></div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j8MkfLTrb3ihHO12rA+UqfLnI0m5u8efyYkE4eE="
    crossorigin=""
  ></script>
  <script>
    function getParam(name) {
      const url = new URL(window.location.href);
      const value = url.searchParams.get(name);
      return value ? decodeURIComponent(value) : null;
    }

    function parseCoords(coordStr) {
      const [lat, lon] = coordStr.split(',').map(Number);
      return [lat, lon];
    }

    const driverStart = parseCoords(getParam("ds"));
    const driverEnd = parseCoords(getParam("de"));
    const passengerStart = parseCoords(getParam("ps"));
    const passengerEnd = parseCoords(getParam("pe"));

    const driverInfo = {
      name: getParam("dn") || "Водитель",
      username: getParam("du") || "@username",
      phone: getParam("dp") || "-",
      car: getParam("dc") || "-",
      experience: getParam("dx") || "-"
    };

    const passengerInfo = {
      name: getParam("pn") || "Пассажир",
      username: getParam("pu") || "@username",
      phone: getParam("pp") || "-"
    };

    // Центрируем карту на Калининградскую область
    const map = L.map('map').setView([54.7, 21.0], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    if (driverStart) L.marker(driverStart).addTo(map).bindPopup("Старт водителя").openPopup();
    if (driverEnd) L.marker(driverEnd).addTo(map).bindPopup("Финиш водителя");
    if (passengerStart) L.marker(passengerStart).addTo(map).bindPopup("Старт пассажира");
    if (passengerEnd) L.marker(passengerEnd).addTo(map).bindPopup("Финиш пассажира");

    if (driverStart && driverEnd) {
      const driverLine = L.polyline([driverStart, driverEnd], { color: 'blue' }).addTo(map);
      map.fitBounds(driverLine.getBounds());
    }

    if (passengerStart && passengerEnd) {
      L.polyline([passengerStart, passengerEnd], { color: 'green' }).addTo(map);
    }

    const infoBox = document.getElementById("info");
    infoBox.innerHTML = `
      <div><b>Водитель:</b> ${driverInfo.name} (${driverInfo.username})<br>
      Телефон: ${driverInfo.phone}<br>
      Машина: ${driverInfo.car}, стаж: ${driverInfo.experience}</div>
      <hr>
      <div><b>Пассажир:</b> ${passengerInfo.name} (${passengerInfo.username})<br>
      Телефон: ${passengerInfo.phone}</div>
    `;
  </script>
</body>
</html>
