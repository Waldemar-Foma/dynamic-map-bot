<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Выбор точек маршрута</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 70vh; }
        .panel { padding: 10px; background: #fff; text-align: center; }
        .button { 
            padding: 10px 15px; 
            margin: 5px; 
            background: #3399ff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
        }
        .status { margin: 10px 0; color: #555; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="panel">
        <button id="startBtn" class="button">Точка А</button>
        <button id="endBtn" class="button">Точка Б</button>
        <button id="sendBtn" class="button" disabled>Отправить</button>
        <div class="status" id="status">Выберите обе точки</div>
    </div>

    <script>
        ymaps.ready(init);

        function init() {
            // Центр Калининграда
            const map = new ymaps.Map('map', {
                center: [54.7135, 20.5113],
                zoom: 14
            });

            let points = {
                start: null,
                end: null
            };
            let currentMode = null;

            // Кнопки выбора точек
            document.getElementById('startBtn').addEventListener('click', () => {
                currentMode = 'start';
                updateStatus('Выберите точку А на карте');
            });

            document.getElementById('endBtn').addEventListener('click', () => {
                currentMode = 'end';
                updateStatus('Выберите точку Б на карте');
            });

            // Клик по карте
            map.events.add('click', (e) => {
                if (!currentMode) return;
                
                const coords = e.get('coords');
                
                // Удаляем предыдущую точку
                if (points[currentMode]) {
                    map.geoObjects.remove(points[currentMode].marker);
                }

                // Создаем маркер
                const marker = new ymaps.Placemark(coords, {}, {
                    preset: currentMode === 'start' 
                        ? 'islands#blueIcon' 
                        : 'islands#redIcon'
                });

                map.geoObjects.add(marker);
                
                // Сохраняем данные
                points[currentMode] = {
                    coords: coords,
                    marker: marker
                };

                currentMode = null;
                checkPoints();
            });

            // Отправка в бота
            document.getElementById('sendBtn').addEventListener('click', () => {
                if (!points.start || !points.end) return;
                
                const data = {
                    start: points.start.coords,
                    end: points.end.coords
                };

                // Для WebApp Telegram
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.sendData(JSON.stringify(data));
                    Telegram.WebApp.close();
                } else {
                    alert(`Данные для бота:\n${JSON.stringify(data)}`);
                }
            });

            function checkPoints() {
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = !(points.start && points.end);
                
                if (points.start && points.end) {
                    updateStatus('Готово к отправке');
                } else {
                    updateStatus(points.start ? 'Выберите точку Б' : 'Выберите точку А');
                }
            }

            function updateStatus(text) {
                document.getElementById('status').textContent = text;
            }
        }
    </script>
</body>
</html>
